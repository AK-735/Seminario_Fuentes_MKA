---
title: "Registros de VIH correlacionado con diversos factores"
author: "Amina Khantimirova, Wiam Messari y Emma Arrieta"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    theme: flatly     
    highlight: tango  
    df_print: paged 
---

<style>
body {
  text-align: justify;
  font-family: "Poppins", "Segoe UI", sans-serif;
  background-color: #fff0f5;
  color: #333;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
[Enlace al repositorio de GitHub] (https://github.com/AK-735/Seminario_Fuentes_MKA)

## **Introducción**

El **VIH** hace referencia al virus de la inmunodeficiencia humana. Daña el sistema inmunitario del individuo al destruir un tipo de glóbulo blanco que ayuda a su cuerpo a combatir las infecciones. Esto lo pone en riesgo de tener otras infecciones y enfermedades.

Esta enfermedad afecta a un gran porcentaje de la población española, resultando en un foco de malestar. En este seminario estudiaremos aquellos indicativos que potencian la expresión de dicha enfermedad. 

Nuestro primer foco de interés es estudiar la correlación entre la orientación sexual y el VIH, pero también incluiremos otros factores de riesgo que podrían desencadenar dicho virus.


## **Objetivo general**

- Concienciar a la población española de los diferentes desencadenantes que pueden llevar a contraer el VIH, ya que en su mayoría son evitables.

- Conocer mediante el estudio de tablas la correlación que puede llegar a existir entre la orientación sexual de un individuo y su predisposición a contraer la enfermedad del VIH.


## **Objetivos específicos**

1. ¿La conducta sexual resulta un factor de riesgo para el VIH?
2. ¿Cuál es la comunidad autónoma con más casos de VIH en 2023 por conducta homosexual? ¿Y heterosexual?
2. Relación existente entre el uso de preservativo y el desarrollo del VIH.
3. Relación existente entre el promedio de parejas y el desarrollo del VIH.
4. ¿Cuál es la evolución del impacto de la enfermedad en la población desde 2013 a 2023?
5. ¿Hay más casos de VIH cuanto mayor es la población?
6. Estudio anual de nuesvas infecciones.
7. Factores de riego generales y su influencia en el desarrollo del VIH.

## **Metodología**
Para este seminario empleamos una mezcla de distintos tipos de datos, parte de ellos fueros obtenidos de bases de datos provenientes del gobierno de Castilla y Leon 
mientra que la inmensa mayoría fueron sacadas de un estudio muy profundizado que, al igual de nosotros, estudiaba 
el virus del VIH y los diversos factores que la desencadenan. En la conclusión realizada por el Gobierno de España se llegó a nuestra misma conclusión, las relaciones sexuales
son el mayor desncadenante.

Nuestros datos son variados, tenemos JSON, CSV y ODS. Por ello usamos distintas librerías de R (readr, read_csv, rjson... )

En el estudio podemos apreciar el uso de diferentes formas de union de tabla, que nos ayudaron a comprender los datos mejor, 
destacando el uso full join y left join. Estas herramientas fueron muy importantes para la realización del seminario.

Para realizar nuestro estudio, importamos las tablas que tenemos guardadas en la carpeta DATA de nuestro repositorio.
También necesitaremos una serie de paquetes de R Cran para llevar a cabo el estudio, ejecutamos la siguiente caja de código para ello.

```{r , eval = TRUE,message=FALSE, warning=FALSE}
# Datos importacion
library(shiny)
library(tidyverse)
library(rjson)
library(DT)
library(readODS) #hay que descargarse el paquete readODS

```
### **Importación datos en CSV:**

```{r , eval = TRUE,message=FALSE, warning = FALSE}

tabla_csv_orientacion <- read_csv("Input/DATA/VIH_orientaciónSexual.csv") 

```
### **Importación datos en ODS:**

```{r, eval = TRUE,message=FALSE, warning = FALSE}
Modotransmisioncompleto <- read_ods(path = "Input/DATA/Modotranscompleto.ods") #, sheet = 1, col_names = TRUE,skip = 1)
ModotransmisionVIH <- read_ods("Input/DATA/modotransmisionVIH.ods")
motivosVIH <- read_ods("Input/DATA/motivosVIH.ods")
yearSexoVIH <- read_ods("Input/DATA/yearSexoVIH.ods")

```
### **Cambio en el formato de las columnas**

```{r, eval = TRUE,message=FALSE, warning=FALSE}
Modotransmisioncompleto_limpio <- Modotransmisioncompleto %>%
  rename(
    `HSH` = `Modo de transmisión`,
    
    `Heterosexual_H`= `...3`,
    
    `Heterosexual_M`= `...4`,
  
    `PID_H` = `...5`,
    `PID_M` = `...6`,
    `Materno_Infantil_H` = `...7`,
    `Materno_Infantil_M` = `...8`,
    `Hemoderivados_H` = `...9`,
    `Hemoderivados_M` = `...10`,
    `Transfusión_H`= `...11`,
    `Transfusión_M`= `...12`,
    `Desconocido_H`= `...13`,
    `Desconocido_M`= `...14`,
   
  ) %>%
  select(
    `Año de diagnóstico`, 
    `HSH`,
    `Heterosexual_H`, 
    `Heterosexual_M`,
    `PID_H`, 
    `PID_M`,
    `Materno_Infantil_H`, 
    `Materno_Infantil_M`, 
    `Hemoderivados_H`,
    `Hemoderivados_M`,
    `Transfusión_H`,
    `Transfusión_M`,
    `Desconocido_H`,
    `Desconocido_M`,
    `Total`
    
)

```



### **Importación datos JSON:**

```{r , eval = TRUE,message=FALSE, warning=FALSE}
#file_path <- file.choose()

# Leer JSON de manera segura
REG_Vih <- fromJSON(file = "Input/DATA/registro-nuevas-infecciones-por-vih.json")

# Extraer la lista 'fields' de cada registro
REG_Vih_df <- map_dfr(REG_Vih, ~ .x$fields)

# Mostrar primeras filas en tabla interactiva
#str(REG_Vih_df)   
names(REG_Vih_df)
REG_Vih_df

```


Ahora hacemos un left join, con el objetivo de analizar los datos de las tablas "registro-nuevas-infecciones-por-vih.json" y "VIH_orientaciónSexual.csv".

```{r , eval = TRUE,message=FALSE, warning=FALSE}
tabla_unida <- left_join(REG_Vih_df, tabla_csv_orientacion, by = c("edad" = "Edad", "sexo" = "Sexo"))
glimpse(tabla_unida)
datatable(tabla_unida, options = list(pageLength = 10))
```

### **Comparación casos VIH/conducta**

Esta tabla reúne aquellos casos de VIH provocados por conductas sexuales. El foco principal son los hombres, por lo que aquí son nuestro sujeto de estudio.
Se espera visualizar un conteo de hombres que presenten VIH en base a su preferencia sexual para reflejar el impacto que tiene sobre la población masculina.
Cabe destacar que aquelos hombres en el estudio que marcaron la opción de "Bisexual" formaron parte del grupo "HSH".

```{r, eval = TRUE,message=FALSE, warning=FALSE}

prevalencia_por_conducta <- tabla_csv_orientacion %>%
  filter(`Hábito sexual` %in% c("HSH", "Heterosexual")) %>%
  group_by(`Hábito sexual`) %>%
  summarise(
    Casos = n(),
    VIH_Positivo = sum(VIH == "SÍ"), 
  ) %>%
  mutate(
    `Tasa de Prevalencia (%)` = round((VIH_Positivo / Casos) * 100, 2)
  )

datatable(prevalencia_por_conducta, 
          caption = "Tasa de Prevalencia de VIH por Hábito Sexual")

print(prevalencia_por_conducta)
```



Podemos ver a partir de la tabla cómo sí parece haber cierta relación entre la orientación o hábito sexual y el desarrollo del virus. Para visualizarlo mejor aquí tenemos el gráfico para la prevalencia 


```{r , eval = TRUE, message=FALSE, warning=FALSE}

ggplot(data = prevalencia_por_conducta, 
       aes(x = `Hábito sexual`, 
           y = `Tasa de Prevalencia (%)`,
           fill = `Hábito sexual`)) +
  
  geom_col(colour = "black", width = 0.5) +
  
  scale_fill_manual(
    values = c("HSH" = "red", 
               "Heterosexual" = "blue")
  ) +
  
  geom_text(aes(label = paste0(`Tasa de Prevalencia (%)`, "%")), 
            vjust = -0.6, size = 3) +
  
  labs(
    title = "Gráfico de barras de la prevalencia de VIH",
    x = "Hábito Sexual",
    y = "Tasa de Prevalencia (%)",
    subtitle = "Tasa de Prevalencia de VIH por Hábito Sexual"
  )+
  scale_y_continuous(limits = c(0, 60)) 
```



Aquí tenemos una comparación de aquellos que mantienen relaciones sexuales siempre con preservativo, y los que no. Aquellos que mantienen relaciones homosexuales no suelen usar preservativos con la misma frecuencia que aquellos hombres que mantienen relaciones heterosexuales.
Esto puede ser debido a que no existe riesgo de embarazo. Por ello, es muy importante enfatizar en la población española sobre la importancia de preservativo, más allá del deseo de no concebir:

```{r, eval = TRUE,message=FALSE, warning=FALSE}

uso_preservativo <- tabla_csv_orientacion %>%
  filter(`Hábito sexual` %in% c("HSH", "Heterosexual")) %>%
  group_by(`Hábito sexual`) %>%
  count(`preservativo siempre`, name = "Frecuencia") %>%

  group_by(`Hábito sexual`) %>%
  mutate(
    Total_Grupo = sum(Frecuencia),
    `Porcentaje (%)` = round((Frecuencia / Total_Grupo) * 100, 2)
  ) %>%
  ungroup()

uso_siempre <- uso_preservativo %>% filter(`preservativo siempre` == "SÍ")

datatable(uso_siempre, 
          caption = "Porcentaje de Uso de Preservativo 'Siempre'")
```
De nuevo, tenemos un gráfico para visualizar mejor qué grupos usan preservativos con mayor frecuencia.

```{r, eval = TRUE,message=FALSE, warning=FALSE}
ggplot(data = uso_preservativo, aes(x=`Hábito sexual`, y = `Porcentaje (%)`, color = `preservativo siempre`)) +
  geom_point(size = 8, shape = 18) + 
  geom_line(aes(group = `preservativo siempre`), size = 0.5, linetype = "dashed") + 
  geom_text(aes(label = paste0(`Porcentaje (%)`, "%")), 
            color = "black", 
            size = 3.5, 
            vjust = -1.5,
            hjust = 0.25) +
  
  scale_color_manual(
    values = c("SÍ" = "blue", 
               "NO" = "red")
  ) +
  labs(
    title = "Comparación del Uso Siempre de Preservativo",
    subtitle = "Porcentaje de hombres que usan preservativo en cada hábito sexual",
    x = "Hábito Sexual",
    y = "Porcentaje de Uso (%)",
    color = "¿Preservativo siempre?"
    
  )+
  scale_y_continuous(limits = c(0, 100)) 


```


Aquí empleamos una tabla anterior (__tabla_unida__) para estudiar si el número de parejas afecta en el desarrollo del VIH. Cabe destacar que aquí se han incluido tanto como hombres como mujeres.

Podemos presenciar en la tabla la correlación que existe entre ser hombre y padecer esta enfermedad. Por otra parte es cierto que los hombres en el estudio tendían a tener un número de parejas mayor en comparación a las mujereso, eso afecta a la certeza de estos datos.

```{r, eval = TRUE,message=FALSE, warning=FALSE}

tabla_unida$edad <- as.numeric(tabla_unida$edad) #Nos aseguramos de que edad es numerico.

riesgo_sifilis <- tabla_unida %>%

  filter(d_grupo_riesgo %in% c("Varones homosexuales / bisexuales", "Relaciones Heterosexuales")) %>%

  group_by(d_grupo_riesgo, `Estado sífilis`) %>% 

  summarise(
    Casos = n(),
    `Edad Promedio` = round(mean(edad, na.rm = TRUE), 2),
  ) %>%
  
  arrange(desc(Casos)) 

datatable(riesgo_sifilis, 
          caption = "Distribución por Edad, Riesgo y Sífilis")

promedio_parejas_clinico <- tabla_unida %>%

  mutate(`Parejas ultimo año` = as.numeric(`Parejas ultimo año`)) %>%
  group_by(sexo, estado_clinico) %>%

  summarise(
    `Promedio de Parejas` = round(mean(`Parejas ultimo año`, na.rm = TRUE), 2),
    `Total de Casos` = n(),
  ) %>%

  filter(estado_clinico %in% c("Asintom", "SIDA")) %>%
  arrange(sexo, desc(`Total de Casos`))
datatable(promedio_parejas_clinico, 
          caption = "Relación entre Parejas y Estado Clínico por Sexo")



tabla_unida
```

Aquí vemos un gráfico que explica mejor la tabla de arriba, pero con la adición de rango de edad, ya que vimos que tenía cierta relevancia.

```{r, eval = TRUE,message=FALSE, warning=FALSE}
dispersion <- tabla_unida %>%
  filter(estado_clinico %in% c("Asintom", "SIDA")) %>%
  mutate(edad = as.numeric(edad),
         `Parejas ultimo año` = as.numeric(`Parejas ultimo año`)) %>%
  drop_na(edad, `Parejas ultimo año`, estado_clinico) 


ggplot(data = dispersion, 
       aes(x = edad, 
           y = `Parejas ultimo año`, 
           color = estado_clinico)) +
  
  geom_point(alpha = 0.6, size = 2) +
  geom_smooth(method = "lm", 
              size = 1.2) + 
  
  labs(
    title = "Relación entre Edad y Número de Parejas por Estado Clínico ",
    x = "Edad del Individuo (años)",
    y = "Número de Parejas en el Último Año",
    color = "Estado Clínico"
  ) +
  
  scale_color_manual(values = c("Asintom" = "blue", "SIDA" = "red")) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "bottom")


```
Esta tabla estudia por comunidad autónoma, y basándonos en el grupo de edad, el porcentaje existente de los distintos factores de riesgo incluidos en el estudio que puede desencadenar el virus.

```{r, eval = TRUE,message=FALSE, warning=FALSE}
tabla_relacion_infeccion <- motivosVIH %>%
  group_by( `Comunidades y Ciudades Autónomas`, Motivo, Edad) %>%
  summarise(Total_Casos = n()) %>%
  group_by(`Comunidades y Ciudades Autónomas`) %>%
  mutate(Porcentaje_CCAA = (Total_Casos / sum(Total_Casos)) * 100) %>%
  ungroup()

print(tabla_relacion_infeccion)

```




Lo hemos representado en este tipo de gráfico para poder visualizar la amplitud del estudio, ya que reúne bastante variables.

```{r, eval = TRUE,message=FALSE, warning=FALSE}

tabla_para_grafico <- motivosVIH %>%
  filter(Motivo != "Total") %>% 
  filter(Edad != "Total") %>%   
  filter(`Comunidades y Ciudades Autónomas` != "Total Nacional")%>%
  mutate(
    Edad = recode(Edad,
      "Menos de 40 años" = "<40 Años",
      "40 y más años"    = ">=40 Años"
    )
  )

ggplot(tabla_para_grafico, 
       aes(x = Total, 
           y = `Comunidades y Ciudades Autónomas`, 
           color = Motivo)) + 

  geom_point(size = 1.5, alpha = 0.8) +
  
  facet_wrap(~Edad, scales = "free_x") + 
  labs(
    title = "Distribución de Edad por CCAA",
    subtitle = "Puntos clasificados por categoría de motivo",
    x = "Cantidad ",
    y = "Comunidad Autónoma",
    color = "Motivo de Infección" 
  )
```
Este box-plot nos permite visualizar los diferentes motivos que desencadenan la enfermedad según su rango de edad, ya que hemos notado en la gráfica anterior cómo hay ciertas tendencias respecto a los factores de riesgo dependiendo de la edad.


```{r, eval = TRUE,message=FALSE, warning=FALSE}
ggplot(data = tabla_unida, aes(x= `edad`, y = `d_grupo_riesgo`, coulor = `d_grupo_riesgo`))+
  geom_boxplot(size = 1.5)+
  labs(
    title = "Distribucion de la edad por grupo de riesgo",
    x = "Edad",
    y = "Grupo de Riesgo",
  )



```

En esta tabla empleamos un full join con el objetivo de unir dos tablas que nos da un conteo muy general de los casos en función de la orientación sexual que, recordamos, es uno de nuetsros principale sobjetos de estudio en este seminario.


```{r , eval = TRUE,message=FALSE, warning=FALSE}
tabla_completa <- full_join(REG_Vih_df, tabla_csv_orientacion, by = c("edad" = "Edad", "sexo" = "Sexo"))

incidencia <- tabla_completa %>%
  filter(conducta_sexual %in% c("Homosex", "Hetersex", "Desconocido")) %>%
  group_by(conducta_sexual) %>%
  summarise(

    Casos = n()) 

datatable(incidencia, 
          caption = "Número de casos por conducta sexual")

print(incidencia)


```


El estudio llegaba hasta 2023 por lo que quisimos mostrar las dos provincias que habían detectado el mayor número de casos de VIH a lo largo de este año.

```{r, eval = TRUE,message=FALSE, warning=FALSE}
casos_2023 <- REG_Vih_df %>%
  filter(ano == "2023", conducta_sexual %in% c("Homosex","Hetersex"))%>%
  count(provincia_residencia,conducta_sexual,name = "Casos")

casos_mas_por_conducta <- casos_2023 %>%
  group_by(conducta_sexual) %>%
  filter(Casos == max(Casos)) %>%
  ungroup()
datatable(casos_mas_por_conducta, caption = "Provincia con más casos de VIH en 2023")
casos_mas_por_conducta
  



```

Esta es una distribución dentro de Castilla y León sobre casos de VIH por provincia. Podemos ver cómo Burgos está en tercer lugar, aunque hay que tener en cuenta que en cuanto a rangos Burgos es la tercera provincia más poblada en la comunidad autónoma, detrás de Valladolid y León. 

Con esto vemos que el número de casos es proporcional al número de habitantes de la región por lo que no nos indica nada.

```{r, eval = TRUE,message=FALSE, warning=FALSE}

casos_por_provincia_conteo <- tabla_unida %>%
  filter(test_positivo %in% c("VIH1", "VIH2","VIH12")) %>%
  count(provincia_residencia, name = "Total_Casos")
  

ggplot(data = casos_por_provincia_conteo, 
       aes(x = Total_Casos, 
           y = provincia_residencia))+
  
  geom_point(size = 4, 
             color = "deeppink") +
  
  geom_text(aes(label = Total_Casos), 
            hjust = 0.35, 
            vjust = 2.25,
            size = 3.25, 
            color = "black") +
  
  labs(
    title = "Distribución de Casos de VIH por Provincia",
    x = "Total de Casos de VIH Registrados",
    y = "Provincia de Residencia"
  )
  

```
Visualización de la evolución del impacto de la enfermedad en la población desde 2013 a 2023

```{r, eval = TRUE,message=FALSE, warning=FALSE}
tendencia_anual <- tabla_unida %>%
  mutate(ano_num = as.numeric(ano)) %>%
  filter(ano_num >= 2013 & ano_num <= 2023) %>%
  filter(VIH == "SÍ")%>%
  group_by(ano_num)%>%
  count(ano_num, name = "Casos_Nuevos")

tendencia <- ggplot(data = tendencia_anual, aes(x =ano_num, y = Casos_Nuevos))+
  geom_point(color = "green",size = 3)+
  geom_line(color = "red",size = 1.5) +
  
  geom_text(aes(
    label = Casos_Nuevos), 
    vjust = -1.7, size = 3.5, color = "black") +
    

    labs(
      title = "Evolución Anual de Nuevas Infecciones por VIH (2013-2023)",
      x = "Año de Diagnóstico",
      y = "Número de Nuevos Casos Registrados"
    ) 
  
tendencia


```
Correlacion si la caida o subida de casos esta influenciada por el grupo de riesgo. Con esto queremos ver si la variación en los nieveles de los factores de riesgo a lo largo de los años tendría impacto sobre el desarrollo de la enfermedad. Podemos ver una clara correlación entre ambas gráficas.

```{r, eval = TRUE,message=FALSE, warning=FALSE}
grupo_casos_nuevos <- tabla_unida %>%
  mutate(ano = as.numeric(ano))%>%
  filter(VIH == "SÍ")%>%
  filter(ano >= 2013 & ano <= 2023)%>%
  
  group_by(ano, d_grupo_riesgo, VIH)%>%
  summarise(
    Casos_Nuevos = n(),
    .groups = 'drop') %>%
  select(ano, d_grupo_riesgo, VIH, Casos_Nuevos)


ggplot(data = grupo_casos_nuevos, aes(x = ano, y = Casos_Nuevos, color = d_grupo_riesgo))+
  geom_line(linewidth = 1.5) +
  geom_point(size =2.5)+
  labs(
    title = "Relación Grupo de riesgo - Nuevos casos (2013-2023)",
    x = "Año de Diagnóstico ",
    y = "Numero de Nuevos Casos Registrados",
    color = "Grupo de Riesgo" 
  )

```

Aquí profuncizamos en la relación que pueda llegar a existir entre el nº de parejas y la enfeermedad. 
En este caso, aunque los individuos de 60 sí muestra correlación, lo de 40 mustran lo contrario por lo que no podemos cercionarnos de la existencia de una correlación fiable.

```{r, eval = TRUE,message=FALSE, warning=FALSE}

parejas_vih <- tabla_unida %>%
  filter(ano >= 2013 & ano <= 2023) %>%
  filter ( VIH != "NA") %>%
  group_by(ano, VIH, `Parejas ultimo año`)%>%
  select(ano, VIH , `Parejas ultimo año`)

tendencia_parejas <- ggplot(data = parejas_vih, aes(y = `Parejas ultimo año`, x = ano, color = VIH))+
  geom_point(alpha = 0.7)+

  labs(
    title = "Frecuencia de Parejas Sexuales por Año y Estado de VIH",
    x = "Número de Parejas Sexuales en el Último Año",
    y = "Año de la Encuesta",
    color = "Estado de VIH",
    size = "Nº de Personas"
  ) 
tendencia_parejas
  
```


Estudiamos la posible correlación de la caida o subida de casos ylas variaciones en los factores de riesgo.
Hemos creado una tabla más simple a partir de nuestra base de datos que tenía una tabla compuesta. De esta manera su representación resulta más sencilla de manejar y entendible en el gráfico.

```{r, eval = TRUE,message=FALSE, warning=FALSE}
Modotransmisioncompleto_limpio <- Modotransmisioncompleto %>%
  rename(
    `HSH` = `Modo de transmisión`,
    
    `Heterosexual_H`= `...3`,
    
    `Heterosexual_M`= `...4`,
  
    `PID_H` = `...5`,
    `PID_M` = `...6`,
    `Materno_Infantil_H` = `...7`,
    `Materno_Infantil_M` = `...8`,
    `Hemoderivados_H` = `...9`,
    `Hemoderivados_M` = `...10`,
    `Transfusión_H`= `...11`,
    `Transfusión_M`= `...12`,
    `Desconocido_H`= `...13`,
    `Desconocido_M`= `...14`,
   
  ) %>%
  select(
    `Año de diagnóstico`, 
    `HSH`,
    `Heterosexual_H`, 
    `Heterosexual_M`,
    `PID_H`, 
    `PID_M`,
    `Materno_Infantil_H`, 
    `Materno_Infantil_M`, 
    `Hemoderivados_H`,
    `Hemoderivados_M`,
    `Transfusión_H`,
    `Transfusión_M`,
    `Desconocido_H`,
    `Desconocido_M`,
    `Total`
    
)

```

```{r, eval = TRUE,message=FALSE, warning=FALSE}

nombres_deseados <- c(
    "Año de diagnóstico", 
    "HSH",
    "Heterosexual_H", "Heterosexual_M", 
    "PID_H", "PID_M",
    "Materno_Infantil_H", "Materno_Infantil_M", 
    "Hemoderivados_H", "Hemoderivados_M", 
    "Transfusion_H", "Transfusion_M",
    "Desconocido_H", "Desconocido_M",
    "Total" )
Modotransmisioncompleto_limpio <- Modotransmisioncompleto[-c(1:2), ]

names(Modotransmisioncompleto_limpio) <- nombres_deseados


Modotransmisioncompleto_limpio <- Modotransmisioncompleto_limpio %>%
    mutate(
        `Año de diagnóstico` = as.character(`Año de diagnóstico`),
      
        across(c(HSH:Total), as.numeric)
    )

```

```{r, eval = TRUE,message=FALSE, warning=FALSE}

correlacion_tendencia_motivo <- tendencia_anual %>% 
  mutate(`Año de diagnóstico`= as.character(ano_num))%>%
  inner_join(
    Modotransmisioncompleto_limpio, by ="Año de diagnóstico"
  )%>%
  group_by(`Año de diagnóstico`)%>%
  ungroup() %>%
  select(
    Año = `Año de diagnóstico`,
    `Casos_Nuevos`,
    `HSH`,
    `Heterosexual_H`, 
    `Heterosexual_M`,
    `PID_H`, 
    `PID_M`,
    `Materno_Infantil_H`, 
    `Materno_Infantil_M`, 
    `Hemoderivados_H`,
    `Hemoderivados_M`,
    `Transfusion_H`,
    `Transfusion_M`,
    `Desconocido_H`,
    `Desconocido_M`,
    `Total`
  ) %>%
  arrange(Año)

datatable(correlacion_tendencia_motivo, 
          caption = "Correlación: Tendencia Anual vs. Modo y CCAA de Transmisión",
          options = list(pageLength = 10, scrollX = TRUE))


```




```{r, eval = TRUE,message=FALSE, warning=FALSE}
library(ggplot2)

# Definición manual de los colores. Se mantienen los nombres de la leyenda.
motivos_colores <- c(
    "Total Casos Nuevos" = "black",
    "HSH" = "#E41A1C",           
    "Heterosexual" = "#377EB8",   
    "Uso de Drogas IV (PID)" = "#4DAF4A", 
    "Materno-Infantil" = "#984EA3", 
    "Hemoderivados" = "#FF7F00",  
    "Transfusión" = "#FFFF33",    
    "Desconocido" = "#A65628"     
)

tendencia_motivos <- ggplot(data = correlacion_tendencia_motivo, aes(x = `Año`)) + 
  
  # --- Capas para los Motivos Individuales (más transparentes) ---
  
  # Mantenemos las líneas y puntos para cada motivo
  # Usamos alpha=0.6 para que no opaquen la línea total.
  geom_line(aes(y = HSH, color = "HSH"), linewidth = 1, alpha = 0.6) +
  geom_point(aes(y = HSH, color = "HSH"), size = 2, alpha = 0.6) +
  
  geom_line(aes(y = Heterosexual_H, color = "Heterosexual"), linewidth = 1, alpha = 0.6) +
  geom_point(aes(y = Heterosexual_H, color = "Heterosexual"), size = 2, alpha = 0.6) +
  
  geom_line(aes(y = PID_H, color = "Uso de Drogas IV (PID)"), linewidth = 1, alpha = 0.6) +
  geom_point(aes(y = PID_H, color = "Uso de Drogas IV (PID)"), size = 2, alpha = 0.6) +
  
  geom_line(aes(y = Hemoderivados_H, color = "Hemoderivados"), linewidth = 1, alpha = 0.6) +
  geom_point(aes(y = Hemoderivados_H, color = "Hemoderivados"), size = 2, alpha = 0.6) +
  
  geom_line(aes(y = Transfusion_H, color = "Transfusión"), linewidth = 1, alpha = 0.6) +
  geom_point(aes(y = Transfusion_H, color = "Transfusión"), size = 2, alpha = 0.6) +
  
  geom_line(aes(y = Desconocido_H, color = "Desconocido"), linewidth = 1, alpha = 0.6) +
  geom_point(aes(y = Desconocido_H, color = "Desconocido"), size = 2, alpha = 0.6) +

  geom_line(aes(y = Materno_Infantil_H, color = "Materno-Infantil"), linewidth = 1, alpha = 0.6) +
  geom_point(aes(y = Materno_Infantil_H, color = "Materno-Infantil"), size = 2, alpha = 0.6) +
  
  # --- Capa para el Total de Casos Nuevos (la línea de referencia) ---
  
  # Usamos un linewidth más grande y alpha=1.0 para que destaque.
  geom_line(aes(y = Casos_Nuevos, color = "Total Casos Nuevos"), linewidth = 2, alpha = 1.0) +
  geom_point(aes(y = Casos_Nuevos, color = "Total Casos Nuevos"), size = 2, alpha = 1.0) +
  
  # Aplicar la leyenda y los colores definidos manualmente
  scale_color_manual(
    name = "Motivo de Transmisión", 
    values = motivos_colores,
    breaks = names(motivos_colores),
    guide = guide_legend(
      override.aes = list(
        # Ajustamos el tamaño de los íconos de la leyenda para reflejar el contraste
        linetype = c(1, rep(1, length(motivos_colores) - 1)), # Todas son líneas
        linewidth = c(2, rep(1, length(motivos_colores) - 1)), # La primera (Total) es más gruesa
        shape = c(16, rep(16, length(motivos_colores) - 1)),   # Todos son puntos
        size = c(4, rep(2, length(motivos_colores) - 1)), # El punto del Total es más grande
        alpha = c(1.0, rep(0.8, length(motivos_colores) - 1)) # Transparencia
      )
    )
  ) +
  
  # Texto solo para el total de Casos Nuevos (se mantiene visible)
  geom_text(data = correlacion_tendencia_motivo,
            aes(label = Casos_Nuevos, y = Casos_Nuevos),
            vjust = -1.7, size = 3.5, color = "black", show.legend = FALSE) +
  
  labs(
    title = "Evolución Anual de Nuevas Infecciones por VIH (2013-2023)",
    x = "Año de Diagnóstico",
    y = "Número de Nuevos Casos Registrados"
  ) +
  theme_minimal()

tendencia_motivos
```



## **Resultados**
A medida que desarrollábamos el seminario fuimos recogiendo y mencionando pequeñas conclusiones a las que llegábamos.

Al final vemos como el porcentaje de casos VIH en la población española han disminuido drásticamente, notando un  mínimo en los años 2019-2020 que coinciden con los años de la pandemia, cuando el contacto humano se vió reducido. 

Cabe destacar que los hombres han sido los proganistas de este estudio, llevando la delantera en todos los estudios realizados, tanto en aquellos dirigidos a contar el número de parejas anual como a los que marcaban los casos de VIH positivo, esto provocó dificultad para esclarecer si dichos datos son extrapolables o si han sido condicionadas.

Esto es debido a que el número de parejas en sí es un factor de riesgo para el VIH, y el sexo masculino muestra predisposición en los estudios. Por lo tanto, no sabemos si el número de parejas tiene efecto en el desarrollo del virus, o si se ve condicionada por el hecho de que se trata del sexo masculino.

En general, las relaciones HSH han llevado la delantera en todos los estudios, por lo que ha satisfecho nuestra hipótesis inicial. Aunque cabe mencionar que nuetsro objetivo era más amplio, pero nuetsro foco principal radicaba en estas.

## **Conclusiones generales**

La principal conclusión es que el esfuerzo de prevención y control epidemiológico debe seguir centrándose en las prácticas de riesgo sexual (HSH y Heterosexual), ya que son las vías responsables de la mayoría de las nuevas infecciones por VIH registradas en el periodo 2013-2022.
Dentro de las prácticas de riesgo sexual debemos destacar las relaciones HSH, que fueron nuestro objeto principal en el estudio.

Mediante la comparativa de gráficas y diversas tablas hemos llegado a la conclusión de que hay una correlación importante entre el desarrollo del VIH y las relaciones HSH.
Es por ello que creemos necesario una concienciación respecto a las enfermedades de transmisión sexual, ya que, como queríamos probar en al inicio de este seminario, una inmensa mayoría de los casos son prevenibles aplicando el cuidado necesario y responsabilizandose de la salud, no solo propia, sino del colectivo Español.

Al mismo tiempo,nos gustaría mencionar la alta proporción de casos con motivo de transmisión Desconocido, esto nos indica una necesidad de mejorar los métodos de recolección de datos. De esta manera tendremos bases de datos más completas y los estudios podrán realizarse con mayor precisión en el futuro.

## **Referencias**
__Los datos de las tablas importadas para este estudio tienen su origen aquí__:

- Sec. (n.d.). Encuesta de Anticoncepción en España 2024. Sociedad Española De Contracepción. Retrieved October 15, 2025, from https://sec.es/encuesta-de-anticoncepcion-en-espana-2024/
- Uso de preservativo y número de parejas sexuales en hombres que tienen sexo con hombres con sífilis. (n.d.). Retrieved October 15, 2025, from https://www.actasdermo.org/es-pdf-S0001731010003364

- Unidad de vigilancia de VIH, ITS y hepatitis. (2024). VIGILANCIA EPIDEMIOLÓGICA DEL VIH y SIDA EN ESPAÑA 2023. In Centro Nacional de Epidemiología, Instituto de Salud Carlos III/ División de control de VIH, ITS, Hepatitis virales y tuberculosis, & Ministerio de Sanidad, SISTEMA DE INFORMACIÓN SOBRE NUEVOS DIAGNÓSTICOS DE VIH REGISTRO NACIONAL DE CASOS DE SIDA [Report]. https://www.sanidad.gob.es/ciudadanos/enfLesiones/enfTransmisibles/sida/vigilancia/docs/Informe_VIH_SIDA_2023_Nov_2024_def.pdf

- National Library of Medicine. (n.d.). VIH. Retrieved October 16, 2025, from https://medlineplus.gov/spanish/hiv.html

- De Castilla y León, J. (s. f.). Datos abiertos de Castilla y León. Datos Abiertos. https://datosabiertos.jcyl.es/web/es/datos-abiertos-castilla-leon.html

__Aquí están las herramientes empleadas para saber realizar el código de Shiny:__

- __Temario consultado para saber como usar shiny__ : RPubs - Introducción a Shiny. (s. f.). https://www.rpubs.com/JohanMarin/Shiny

- __Temario de ampliación sobre como usar shiny__ : 
  Custom Bootstrap Sass Themes for shiny and rmarkdown. (s. f.). https://rstudio.github.io/bslib/

  Apply a function to each element of a vector — map. (s. f.).           https://purrr.tidyverse.org/reference/map.html

  Ryan, Y. (2022, 19 octubre). Creación de aplicaciones web interactivas con R y Shiny. Programming Historian. https://programminghistorian.org/es/lecciones/creacion-de-aplicacion-shiny
Strayer, N. (s. f.). Shiny. Shiny. https://shiny.posit.co/r/articles/build/css/



